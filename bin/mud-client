#!/usr/local/bin/php
<?php

$port       = 9000;
$address    = '192.168.1.33';

$port       = 9001;
$address    = 'localhost';

$port       = 9000;
$address    = 'balderdash.ru';

define ( 'KEY_ESC', "\x1b" );
define ( 'KEY_ENTER', "\x0d" );
define ( 'KEY_BACKSPACE', "\x7f" );
define ( 'KEY_LEFT',    269);
define ( 'KEY_RIGHT',   261);
define ( 'KEY_UP',      259);
define ( 'KEY_DOWN',    258);

$GLOBALS['debug'] = 0;
$GLOBALS['history']['cursor'] = false;


$commands = array(
    'qй' => 'command_exit',
    'iш' => 'command_prompt',
    'dв' => 'command_debug',
);

class Output
{
    private $window;

    private $colors;

    public function __construct(){
        ncurses_getmaxyx(STDSCR, $row, $col);
        $this->window = ncurses_newwin($row - 1, $col, 0, 0);
        #ncurses_wborder($this->window, 0, 0, 0, 0, 0, 0, 0, 0);

        ncurses_wrefresh($this->window);

        #$this->window = ncurses_newwin($row - 3, $col - 2, 1, 1);
        ncurses_mvwaddstr($this->window, 0, 0, '# ');
        ncurses_wrefresh($this->window);
        ncurses_scrollok($this->window);
        ncurses_wattroff($this->window, 1);

        #ncurses_end();
        #var_dump(NCURSES_A_NORMAL);
        #var_dump(NCURSES_A_REVERSE);
        #die;

        #ncurses_bkgd(NCURSES_A_NORMAL);
        #ncurses_bkgd(NCURSES_COLOR_BLUE);
        #ncurses_wstandout($this->window);
        #ncurses_wcolor_set($this->window, 3);
        #ncurses_refresh();

        #ncurses_wattron($this->window, NCURSES_A_NORMAL);
        ncurses_assume_default_colors(NCURSES_COLOR_WHITE, -1);
        #ncurses_use_default_colors();
        $this->colors = array(
            '30'  => NCURSES_COLOR_BLACK,
            '31'  => NCURSES_COLOR_RED,
            '32'  => NCURSES_COLOR_GREEN,
            '33'  => NCURSES_COLOR_YELLOW,
            '34'  => NCURSES_COLOR_BLUE,
            '35'  => NCURSES_COLOR_MAGENTA,
            '36'  => NCURSES_COLOR_CYAN,
            '37'  => NCURSES_COLOR_WHITE,
        );
        foreach ($this->colors as $color) {
            ncurses_init_pair($color, $color, -1);
        }

        #$b = ncurses_bkgdset(NCURSES_COLOR_BLUE);
        #$a = ncurses_bkgd();
    }

    public function add($text){

        $colors = $this->colors;

        $buffer = $text;
        $output = '';
        while ( false !== ($p = strpos($buffer, "\x1b"))){
            $output = substr($buffer, 0, $p);
            ncurses_waddstr($this->window, $output);

            $e      = strpos($buffer, "m", $p);

            $pair   = substr($buffer, $p + 2, $e - $p - 2);
            $pair   = explode(';', $pair);
            $color  = count($pair) > 1 ? $pair[1] : '37';

            if (isset($colors[$color]) === false){
                ncurses_end();
                var_dump("Incorrect color: ", var_export($color, true));
                var_dump($pair);
                die;
            }

            if ($pair[0]){
                #ncurses_wstandout($this->window);
                ncurses_wattron($this->window, NCURSES_A_BOLD);
            }
            else{
                #ncurses_wstandend($this->window);
                ncurses_wattroff($this->window, NCURSES_A_BOLD);
            }

            if (count($pair) === 1 && $pair[0] === '0'){
                ncurses_wstandend($this->window);
                ncurses_wcolor_set($this->window, NCURSES_COLOR_WHITE);
            }
            else{
                ncurses_wcolor_set($this->window, $colors[$color]);
            }

            $buffer = substr($buffer, $e + 1 );
        }

        ncurses_waddstr($this->window, $buffer);

        #ncurses_waddstr($this->window, "\n\r");
        #ncurses_waddstr($this->window, "\nDEFAULT: " . $text);

        #ncurses_wscrl($this->window, -1);
        ncurses_wrefresh($this->window);

    }
}

class Prompt 
{
    private $window;


    private $row;    
    private $col;

    /**
     * @var PromptInput
     */
    private $input;

    public function __construct(){
        ncurses_getmaxyx(STDSCR, $row, $col);
        $this->window = ncurses_newwin(1, $col, $row-1, 0);
        $this->row = $row-1;
        $this->col = 0;

        ncurses_mvwaddstr($this->window, 0, 0, 'ssss');
        ncurses_wrefresh($this->window);

        $this->input = new PromptInput($this->window);
    }

    public function getCommand(){
        #ncurses_mvgetch($this->row, 0);
        return $this->input->get();
    }
}

class PromptInput
{
    private $window;
    public function __construct($window){
        $this->window = $window;
    }

    function get(){

        static $history = array();
        static $cnt = 0;

        #fwrite( STDOUT, "\n\r> ");
        ncurses_mvwaddstr($this->window, 0, 0, "> ");
        ncurses_wrefresh($this->window);

        $buffer = '';
        $output = '';
        while ( true ){
            $key    = ncurses_getch( );
            $char   = chr($key);

            if ( $char === KEY_ENTER ){
                $GLOBALS['history']['cursor'] = array_search($output, $history);
                if ($GLOBALS['history']['cursor'] === false){
                    $history[] = $output;
                }
                else {
                    $GLOBALS['history']['cursor']++;
                }
                return $output;
            }

            if ( $char === KEY_ESC ){
                #echo "\x0D> " . str_pad(' ', strlen($output));
                return false;
            }

            if ( $char === KEY_BACKSPACE ){
                #echo "\x0D> " . str_pad(' ', strlen($output));
                $output = substr( $output, 0, -1 );
                $buffer = $output;
                #echo "\x0D> " . $output;
                #ncurses_killchar();
                continue;
            }

            if ( $key === KEY_UP ){
                #echo "\x0D> " . str_pad(' ', strlen($output));
                $output = history_search($history, $buffer, -1);
                #echo "\x0D> " . $output;
                continue;
            }

            if ( $key === KEY_DOWN ){
                #echo "\x0D> " . str_pad(' ', strlen($output));
                $output = history_search($history, $buffer, +1);
                #echo "\x0D> " . $output;
                continue;
            }

            $buffer .= $char;
            $output .= $char;
            #echo "\x0D> " . $output;
            ncurses_mvwaddstr($this->window, 0, 0, "> " . $output);
            ncurses_wrefresh($this->window);
        }
    }
}

ncurses_init();
ncurses_refresh();
ncurses_start_color();
ncurses_use_default_colors();
#ncurses_assume_default_colors(-1, 1);
#ncurses_slk_color(1);
#ncurses_def_prog_mode();

#$small = ncurses_newwin(10, 30, 7, 25);
// border our small window.
#ncurses_wborder($small,0,0, 0,0, 0,0, 0,0);
ncurses_refresh();// paint both windows
// move into the small window and write a string
#ncurses_mvwaddstr($small, 5, 5, "   Test  String   ");
// show our handiwork and refresh our small window
#ncurses_wrefresh($small);
$prompt = new Prompt();
$output = new Output();
#$p->getCommand();
#$o->add('ddddd');
#$p->getCommand();
#$p->getCommand();
#$p->getCommand();
#$p->getCommand();
#$p->getCommand();
#$p->getCommand();


#ncurses_getch();


function command_manager($command){
    global $commands;
    static $cache;
    if ( !$cache ){
        foreach ( $commands as $key => $function ){
            $key = iconv( 'UTF-8', 'KOI8-R', $key );
            foreach ( str_split( $key ) as $k ){
                $cache[$k] = $function;
            }
        }
    }

    write_log(sprintf( "KEY: %x", ( int ) ord( $command ) ));

    if ( isset( $cache[$command] ) ){
        $cache[$command]();
        return true;
    }
    return false;
}

function command_exit(  ){
    global $socket, $address, $port, $pid;

    #$c = fgetc(STDIN);
    #printf("KEY: %x\n", (int) ord($c));

    posix_kill( $pid, SIGUSR1);
    pcntl_wait($status); //Protect against Zombie children
    ncurses_end();
    exit;
}

function command_debug(){
    $GLOBALS['debug'] -= 1;
    $GLOBALS['debug'] *= $GLOBALS['debug'];

    echo "DEBUG MODE " . ($GLOBALS['debug'] ? 'ENABLED' : 'DISABLED') . "\r\n";
}

function write_log($info){
    if ($GLOBALS['debug'] === 0){
        return;
    }

    fwrite(STDOUT, "\033[0;33m" . $info . "\033[0m\r\n");
}

function history_search($history, $prefix, $direction = -1){
    $cursor = & $GLOBALS['history']['cursor'];
    if ($cursor === false || $cursor < 0){
        $cursor = count($history);
    }

    if ($cursor + $direction > count($history) - 1){
        $cursor = -1; 
    }

    for ($i = $cursor + $direction; $i >= 0 && $i < count($history); $i += $direction){
        if ( substr($history[$i], 0, strlen($prefix)) === $prefix && $history[$i] !== $prefix){
            $cursor = $i;
            return $history[$i];
        }
    }

    for ($i = count($history) - 1 ; $i > max($cursor, 0) && $i < count($history); $i += $direction){
        if ( substr($history[$i], 0, strlen($prefix)) === $prefix && $history[$i] !== $prefix){
            $cursor = $i;
            return $history[$i];
        }
    }
    $cursor += $direction;

    return $prefix;
}


function command_prompt(  ){
    global $socket, $address, $port, $pid, $prompt;

    while ( true ){

        $cmd = $prompt->getCommand();
        if ( $cmd  === false ){
            break;
        }

        $status = @socket_write( $socket, $cmd . "\n" );
        if ( $status === false){

            $text = "Disconnect from remote host {$address}[$port]: " .  socket_strerror( socket_last_error( )) . "\n";
            fwrite( STDOUT, $text);
            posix_kill( $pid, SIGUSR1);
            pcntl_wait($status); //Protect against Zombie children
            exit( 0 );
        }
    }
    echo "\x0D#";
}

#$port       = 9000;
#$address    = 'balderdash.ru';

$socket = @socket_create( AF_INET, SOCK_STREAM, SOL_TCP);
$connected = 0; 
if ( $socket ){
    $conected = socket_connect( $socket, $address, $port);
}

if ( $connected === true) {
    $text = "Connection successful on IP $address, port $port";
}
else{
    #var_dump( $connected );
    #$text = "Unable to connect {$address}[$port]: " .  socket_strerror( socket_last_error( )) . "\n";
    #echo $text;
    #exit( 1 );
}

$exit = 0;

#socket_set_nonblock( $socket); 
$hello = "Hello \033[1;33mТорнел\033[0m!\033[1;37mСегодня\033[0;37mпрекрасный день\n\n1\033[1;32m1\033[0m1";
$hello = iconv( 'UTF-8', 'KOI8-R', $hello );
#echo $hello;
$output->add($hello);

#system( 'stty -icanon -echo -cread' );

$pid = pcntl_fork();
if ($pid == -1) {

     die('could not fork');

} else if ($pid) {
    // we are the parent
    #system( 'stty -icanon -echo -cread' );
    ncurses_init();
    ncurses_noecho();

    while (true){
        #$input  = fgetc(STDIN);

        $input = ncurses_getch();
        if ($input === 0x1b){
            printf("ESC");
        }
        $input = chr($input);
        write_log(sprintf("CHAR %s ord(%d)", $input, (int) ord($input)));


        if ( $input === false ){
            continue;
        }

        command_manager( $input );

        if ( $input === 'p' ){
            socket_write( $socket, 'PING' );
            write_log('ping');
        }

    }

    #posix_kill( $pid, SIGUSR1);
    #pcntl_wait($status); //Protect against Zombie children
} else {
    // we are the child
    while ( true ){
        #usleep( 30000 );

        $server = @socket_read( $socket, 1024 );
        if ( $server ){
            $output->add($server);
            #fwrite( STDOUT, trim( $server ). "\n");
        }

        if ( $server === false ){
            break;
        }

        if ( $exit ){
            break;
        }
    }
}

socket_close( $socket);
